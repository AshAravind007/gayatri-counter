<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gayatri Japam Counter</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Text:wght@400;700&display=swap');

  html, body {
    margin: 0; padding: 0; height: 100%;
    font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
    background: url('https://applescoop.org/image/wallpapers/watch/colorful-burst-of-swirly-colors-abstract-21-09-2024-1726919980.webp') no-repeat center center fixed;
    background-size: cover;
    color: white;
  }

  body {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }

  main#mainApp {
    flex: 1;
    display: flex;
    flex-direction: column;
    max-width: 480px;
    margin: 2rem auto 3rem;
    background: rgba(0,0,0,0.5);
    border-radius: 20px;
    padding: 20px;
    z-index: 10;
  }

  h1 {
    font-weight: 700;
    font-size: 2.8rem;
    margin: 0 0 1rem;
    text-align: center;
  }

  label {
    display: block;
    margin: 0.8rem 0 0.3rem;
    font-weight: 600;
  }

  input, select {
    width: 100%;
    padding: 0.5rem;
    font-size: 1.2rem;
    border-radius: 10px;
    border: none;
    outline: none;
  }

  button {
    margin-top: 1.5rem;
    padding: 0.8rem;
    font-size: 1.3rem;
    font-weight: 700;
    border: none;
    border-radius: 10px;
    background: #f4f4f5;
    color: #222;
    cursor: pointer;
    transition: background 0.3s ease;
  }

  button:hover {
    background: #ddd;
  }

  #leaderboard {
    margin-top: 1.5rem;
    background: rgba(255 255 255 / 0.2);
    border-radius: 15px;
    padding: 1rem;
    max-height: 180px;
    overflow-y: auto;
  }

  #leaderboard h2 {
    margin-top: 0; margin-bottom: 0.8rem;
    font-weight: 700;
    font-size: 1.5rem;
    border-bottom: 2px solid white;
    padding-bottom: 0.3rem;
  }

  #leaderboard ul {
    margin: 0; padding: 0; list-style: none;
  }

  #leaderboard li {
    margin-bottom: 0.3rem;
    font-size: 1.1rem;
    display: flex; justify-content: space-between;
  }

  /* FULL SCREEN COUNTER MODE */
  #counterScreen {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    font-size: 12rem;
    font-weight: 900;
    display: flex;
    align-items: center;
    justify-content: center;
    user-select: none;
    cursor: pointer;
    background: rgba(0,0,0,0.75);
    color: white;
    letter-spacing: 0.1em;
    z-index: 1000;
    flex-direction: column;
  }

  #summaryScreen {
    margin-top: 1rem;
    background: rgba(255 255 255 / 0.15);
    padding: 1rem;
    border-radius: 15px;
    display: none;
  }

  #summaryScreen h3 {
    margin-top: 0;
    margin-bottom: 0.5rem;
    font-weight: 700;
  }

  #summaryScreen p {
    margin: 0.3rem 0;
    font-size: 1.1rem;
  }

  #restartBtn {
    margin-top: 1rem;
    padding: 0.7rem;
    font-weight: 700;
    font-size: 1.2rem;
    border-radius: 10px;
    border: none;
    background: #f4f4f5;
    color: #222;
    cursor: pointer;
  }

  #restartBtn:hover {
    background: #ddd;
  }

</style>
</head>
<body>
<main id="mainApp">

  <h1>Gayatri Japam Counter</h1>

  <form id="inputForm">
    <label for="nameInput">Name</label>
    <input id="nameInput" type="text" placeholder="Your name" required autocomplete="off" />

    <label for="cityInput">City</label>
    <input id="cityInput" type="text" placeholder="Your city" required autocomplete="off" />

    <label for="countSelect">Select Count</label>
    <select id="countSelect" required>
      <option value="108">108</option>
      <option value="1008" selected>1008</option>
      <option value="custom">Custom</option>
    </select>

    <input id="customCountInput" type="number" placeholder="Enter custom count" min="1" style="display:none; margin-top:10px;" />

    <button type="submit">Start Japam</button>
  </form>

  <div id="leaderboard">
    <h2>Leaderboard</h2>
    <ul id="leaderboardList">
      <li>Loading...</li>
    </ul>
  </div>

  <div id="counterScreen" tabindex="0" style="display:none;">0</div>

  <section id="summaryScreen">
    <h3>Session Summary</h3>
    <p id="summaryProper"></p>
    <p id="summaryFast"></p>
    <p id="summarySlow"></p>
    <button id="restartBtn">Restart</button>
  </section>

</main>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
  // Your Firebase config (replace with your own)
  const firebaseConfig = {
    apiKey: "AIzaSyA9FlBdTJOUEC11Rw9FFw9z0N1OrpPaJAo",
    authDomain: "gayatri-japam-counter.firebaseapp.com",
    databaseURL: "https://gayatri-japam-counter-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "gayatri-japam-counter",
    storageBucket: "gayatri-japam-counter.appspot.com",
    messagingSenderId: "349097142038",
    appId: "1:349097142038:web:adecc60bdcf58c4cf15237"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Elements
  const inputForm = document.getElementById('inputForm');
  const nameInput = document.getElementById('nameInput');
  const cityInput = document.getElementById('cityInput');
  const countSelect = document.getElementById('countSelect');
  const customCountInput = document.getElementById('customCountInput');
  const counterScreen = document.getElementById('counterScreen');
  const leaderboardList = document.getElementById('leaderboardList');
  const summaryScreen = document.getElementById('summaryScreen');
  const summaryProper = document.getElementById('summaryProper');
  const summaryFast = document.getElementById('summaryFast');
  const summarySlow = document.getElementById('summarySlow');
  const restartBtn = document.getElementById('restartBtn');

  // Tap timing thresholds (milliseconds)
  const MIN_TAP_INTERVAL = 2000;
  const PROPER_LOWER = 7000;
  const PROPER_UPPER = 10000;

  let isCounting = false;
  let tapCount = 0;
  let lastTapTime = 0;
  let properCount = 0;
  let quickCount = 0;
  let slowCount = 0;
  let targetCount = 1008;
  let userName = '';
  let userCity = '';

  // Show/hide custom count input
  countSelect.addEventListener('change', () => {
    if(countSelect.value === 'custom'){
      customCountInput.style.display = 'block';
      customCountInput.required = true;
    } else {
      customCountInput.style.display = 'none';
      customCountInput.required = false;
    }
  });

  // Handle form submit
  inputForm.addEventListener('submit', e => {
    e.preventDefault();

    userName = nameInput.value.trim() || "Anonymous";
    userCity = cityInput.value.trim() || "Unknown";

    if(countSelect.value === 'custom') {
      const customVal = parseInt(customCountInput.value);
      if(!customVal || customVal < 1){
        alert("Please enter a valid custom count.");
        return;
      }
      targetCount = customVal;
    } else {
      targetCount = parseInt(countSelect.value);
    }

    // Reset counters
    tapCount = 0;
    lastTapTime = 0;
    properCount = 0;
    quickCount = 0;
    slowCount = 0;

    // Hide form and leaderboard, show counter screen full screen
    inputForm.style.display = 'none';
    leaderboardList.parentElement.style.display = 'none';
    summaryScreen.style.display = 'none';
    counterScreen.style.display = 'flex';
    counterScreen.textContent = '0';
    counterScreen.focus();

    isCounting = true;
  });

  // Tap counter logic
  counterScreen.addEventListener('click', () => {
    if(!isCounting) return;
    const now = Date.now();
    if(now - lastTapTime < MIN_TAP_INTERVAL) return;

    tapCount++;
    if(lastTapTime !== 0){
      const diff = now - lastTapTime;
      if(diff >= PROPER_LOWER && diff <= PROPER_UPPER){
        properCount++;
      } else if(diff < PROPER_LOWER){
        quickCount++;
      } else {
        slowCount++;
      }
    }
    lastTapTime = now;

    counterScreen.textContent = tapCount;

    if(tapCount >= targetCount){
      isCounting = false;
      showSummary();
      submitToLeaderboard();
    }
  });

  // Show summary after completion
  function showSummary(){
    counterScreen.style.display = 'none';
    summaryScreen.style.display = 'block';

    summaryProper.textContent = `Proper Japams: ${properCount}`;
    summaryFast.textContent = `Too Fast: ${quickCount}`;
    summarySlow.textContent = `Too Slow: ${slowCount}`;
  }

  // Restart
  restartBtn.addEventListener('click', () => {
    summaryScreen.style.display = 'none';
    inputForm.style.display = 'block';
    leaderboardList.parentElement.style.display = 'block';
    counterScreen.style.display = 'none';
    tapCount = 0;
    lastTapTime = 0;
    properCount = 0;
    quickCount = 0;
    slowCount = 0;
    isCounting = false;
  });

  // Submit user session to Firebase Realtime Database leaderboard
  function submitToLeaderboard(){
    const leaderboardRef = db.ref('leaderboard');
    leaderboardRef.push({
      name: userName,
      city: userCity,
      count: properCount,
      timestamp: Date.now()
    });
  }

  // Fetch & display live leaderboard (top 10)
  function updateLeaderboard(snapshot){
    leaderboardList.innerHTML = '';
    if(!snapshot || snapshot.exists() === false){
      leaderboardList.innerHTML = '<li>No entries yet</li>';
      return;
    }

    // Convert snapshot to array, sort by count desc, timestamp asc (earlier better)
    const data = [];
    snapshot.forEach(childSnapshot => {
      data.push(childSnapshot.val());
    });

    data.sort((a,b) => {
      if(b.count !== a.count) return b.count - a.count;
      return a.timestamp - b.timestamp;
    });

    data.slice(0,10).forEach(entry => {
      const li = document.createElement('li');
      li.textContent = `${entry.name} (${entry.city}) - ${entry.count}`;
      leaderboardList.appendChild(li);
    });
  }

  // Listen for changes on leaderboard
  const leaderboardRef = db.ref('leaderboard');
  leaderboardRef.on('value', updateLeaderboard);

</script>
</body>
</html>
