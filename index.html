<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gayatri Japam Counter</title>
  <style>
    /* Reset and base */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
        Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      background: linear-gradient(135deg, #8e9eab, #eef2f3, #8e9eab);
      color: #1d1d1f;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 2rem;
      user-select: none;
    }
    h1 {
      font-weight: 600;
      font-size: 2.8rem;
      margin-bottom: 1rem;
      color: #111;
      text-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    #inputForm, #summary {
      background: rgba(255 255 255 / 0.85);
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 6px 15px rgba(0,0,0,0.1);
      max-width: 400px;
      width: 100%;
      margin-bottom: 2rem;
      text-align: center;
      transition: opacity 0.3s ease;
    }
    input[type="text"], input[type="number"], select {
      width: 100%;
      padding: 1rem 1.2rem;
      font-size: 1.2rem;
      margin-bottom: 1rem;
      border: 1px solid #c8c7cc;
      border-radius: 12px;
      outline-offset: 2px;
      outline-color: #007aff;
      transition: border-color 0.3s ease;
    }
    input[type="text"]:focus, input[type="number"]:focus, select:focus {
      border-color: #007aff;
    }
    button {
      width: 100%;
      padding: 1rem;
      font-size: 1.3rem;
      font-weight: 600;
      color: white;
      background: #007aff;
      border: none;
      border-radius: 14px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      box-shadow: 0 8px 15px rgba(0,122,255,0.3);
    }
    button:hover {
      background: #005ecb;
      box-shadow: 0 10px 20px rgba(0,94,203,0.5);
    }
    #leanback {
      display: none;
      font-size: 14rem;
      font-weight: 800;
      color: #007aff;
      text-shadow:
        0 3px 8px rgba(0,122,255,0.4),
        0 8px 15px rgba(0,122,255,0.25);
      height: 80vh;
      line-height: 14rem;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      cursor: pointer;
      transition: color 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #summary p {
      font-size: 1.3rem;
      line-height: 1.6;
      color: #222;
    }
    #summary h2 {
      font-weight: 700;
      margin-bottom: 1rem;
      color: #111;
    }
    #leaderboard {
      max-width: 400px;
      width: 100%;
      background: rgba(255 255 255 / 0.85);
      border-radius: 12px;
      box-shadow: 0 6px 12px rgba(0,0,0,0.1);
      padding: 1rem 2rem;
      list-style: none;
      margin: 0 auto 4rem auto;
      color: #111;
      font-size: 1.1rem;
    }
    #leaderboard li {
      border-bottom: 1px solid #ddd;
      padding: 0.5rem 0;
    }
    #leaderboard li:last-child {
      border-bottom: none;
    }
    @media (max-width: 480px) {
      h1 {
        font-size: 2rem;
      }
      #leanback {
        font-size: 8rem;
        height: 60vh;
        line-height: 8rem;
      }
      #inputForm, #summary, #leaderboard {
        max-width: 95vw;
        padding: 1.5rem;
      }
      input[type="text"], input[type="number"], select, button {
        font-size: 1rem;
        padding: 0.75rem 1rem;
      }
    }
  </style>
</head>
<body>

  <h1>Gayatri Japam Counter</h1>

  <div id="inputForm">
    <input type="text" id="name" placeholder="Your Name" required autocomplete="off" />
    <input type="text" id="city" placeholder="Your City" required autocomplete="off" />
    <select id="targetCount" aria-label="Select number of chants">
      <option value="108">108</option>
      <option value="1008">1008</option>
      <option value="custom">Custom</option>
    </select>
    <input type="number" id="customCount" placeholder="Enter custom count" style="display:none;" min="1" autocomplete="off" />
    <button id="startBtn" aria-label="Start chanting">Start</button>
  </div>

  <div id="leanback" tabindex="0" role="button" aria-live="polite"></div>

  <div id="summary" aria-live="polite" role="region" aria-label="Session summary">
    <h2>Session Summary</h2>
    <p id="summaryText"></p>
    <button id="restartBtn" aria-label="Restart chanting">Restart</button>
  </div>

  <h2>Leaderboard</h2>
  <ul id="leaderboard" aria-live="polite" role="list"></ul>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA9FlBdTJOUEC11Rw9FFw9z0N1OrpPaJAo",
      authDomain: "gayatri-japam-counter.firebaseapp.com",
      projectId: "gayatri-japam-counter",
      storageBucket: "gayatri-japam-counter.appspot.com",
      messagingSenderId: "349097142038",
      appId: "1:349097142038:web:adecc60bdcf58c4cf15237",
      measurementId: "G-NRGGXQH0XV"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const inputForm = document.getElementById("inputForm");
    const leanback = document.getElementById("leanback");
    const summary = document.getElementById("summary");
    const summaryText = document.getElementById("summaryText");
    const leaderboard = document.getElementById("leaderboard");
    const startBtn = document.getElementById("startBtn");
    const restartBtn = document.getElementById("restartBtn");
    const targetCountSelect = document.getElementById("targetCount");
    const customCountInput = document.getElementById("customCount");

    targetCountSelect.addEventListener("change", () => {
      customCountInput.style.display = targetCountSelect.value === "custom" ? "block" : "none";
    });

    let name = "";
    let city = "";
    let targetCount = 108;

    let tapCount = 0;
    let lastTapTime = 0;

    let properCount = 0;
    let quickCount = 0;
    let slowCount = 0;

    const MIN_TAP_INTERVAL = 2000;
    const PROPER_LOWER = 7000;
    const PROPER_UPPER = 10000;

    startBtn.onclick = () => {
      name = document.getElementById("name").value.trim() || "Anonymous";
      city = document.getElementById("city").value.trim() || "Unknown City";

      if (targetCountSelect.value === "custom") {
        const val = parseInt(customCountInput.value);
        if (!val || val < 1) {
          alert("Please enter a valid custom count");
          return;
        }
        targetCount = val;
      } else {
        targetCount = parseInt(targetCountSelect.value);
      }

      inputForm.style.opacity = 0;
      setTimeout(() => {
        inputForm.style.display = "none";
        leanback.style.display = "flex";
        leanback.focus();

        tapCount = 0;
        lastTapTime = 0;
        properCount = 0;
        quickCount = 0;
        slowCount = 0;

        updateCountDisplay();
      }, 300);
    };

    function updateCountDisplay() {
      leanback.textContent = tapCount;
    }

    leanback.onclick = () => {
      const now = Date.now();
      if (now - lastTapTime < MIN_TAP_INTERVAL) {
        return;
      }
      tapCount++;
      if (lastTapTime !== 0) {
        const diff = now - lastTapTime;
        if (diff >= PROPER_LOWER && diff <= PROPER_UPPER) properCount++;
        else if (diff < PROPER_LOWER) quickCount++;
        else slowCount++;
      }
      lastTapTime = now;

      updateCountDisplay();

      if (tapCount >= targetCount) {
        leanback.style.display = "none";
        showSummary();
        submitSession();
      }
    };

    function showSummary() {
      summary.style.display = "block";
      summaryText.innerHTML = `
        Name: <strong>${name}</strong><br />
        City: <strong>${city}</strong><br />
        Target Count: <strong>${targetCount}</strong><br />
        Proper Japas: <strong>${properCount}</strong><br />
        Quick Japas: <strong>${quickCount}</strong><br />
        Slow Japas: <strong>${slowCount}</strong>
      `;
    }

    restartBtn.onclick = () => {
      summary.style.display = "none";
      inputForm.style.display = "block";
      inputForm.style.opacity = 1;
      leanback.style.display = "none";
    };

    async function submitSession() {
      try {
        await addDoc(collection(db, "sessions"), {
          name,
          city,
          targetCount,
          properCount,
          quickCount,
          slowCount,
          timestamp: Date.now(),
        });
      } catch (e) {
        alert("Error saving session: " + e.message);
      }
    }

    const q = query(collection(db, "sessions"), orderBy("properCount", "desc"), limit(10));
    onSnapshot(q, (snapshot) => {
      leaderboard.innerHTML = "";
      snapshot.forEach((doc) => {
        const d = doc.data();
        leaderboard.innerHTML += `<li><strong>${d.name}</strong> (${d.city}): ${d.properCount} / ${d.targetCount}</li>`;
      });
    });
  </script>
</body>
</html>
